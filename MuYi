#!/bin/bash

# ==============================================
# è‡ªåŠ¨é…ç½®è„šæœ¬ - æœ€ç»ˆä¿®æ­£ç‰ˆ
# ç¡®ä¿èƒ½æ­£ç¡®ä¿®æ”¹ config.json å’Œ ritual.sh
# ==============================================

# é…ç½®éƒ¨åˆ†
DEFAULT_VALUE="265261"
RITUAL_COMMAND_PATH="$HOME/Desktop/ritual.command"
WORK_DIR="$HOME/infernet-container-starter/deploy"

# ç¾è§‚çš„æ‰“å°å‡½æ•°
print_header() {
    echo -e "\n\033[34m======================================\033[0m"
    echo -e "\033[34m $1 \033[0m"
    echo -e "\033[34m======================================\033[0m"
}

print_success() {
    echo -e "\033[32mâœ… $1\033[0m"
    sleep 1
}

print_error() {
    echo -e "\033[31mâŒ é”™è¯¯ï¼š$1\033[0m"
    sleep 1
}

print_info() {
    echo -e "\033[36mâ„¹ï¸ $1\033[0m"
    sleep 1
}

# 1. æ£€æŸ¥DockerçŠ¶æ€
check_docker() {
    if ! docker ps &> /dev/null; then
        print_info "Dockeræœªè¿è¡Œï¼Œå°è¯•å¯åŠ¨..."
        
        if ! open -a Docker; then
            print_error "æ— æ³•å¯åŠ¨Dockerï¼Œè¯·ç¡®è®¤å·²å®‰è£…Docker Desktop"
            echo "è¯·ä»å®˜ç½‘ä¸‹è½½ï¼šhttps://www.docker.com/products/docker-desktop/"
            exit 1
        fi
        
        print_info "ç­‰å¾…Dockerå¯åŠ¨(çº¦10ç§’)..."
        for i in {1..10}; do
            sleep 1
            if docker ps &> /dev/null; then
                print_success "Dockerå·²æˆåŠŸå¯åŠ¨"
                return 0
            fi
        done
        
        print_error "Dockerå¯åŠ¨è¶…æ—¶ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥"
        exit 1
    else
        print_success "Dockerå·²åœ¨è¿è¡Œ"
    fi
}

# 2. æ£€æŸ¥jqå·¥å…·
check_jq() {
    if ! command -v jq &> /dev/null; then
        print_info "jqå·¥å…·æœªå®‰è£…ï¼Œå°è¯•è‡ªåŠ¨å®‰è£…..."
        
        if ! command -v brew &> /dev/null; then
            print_error "Homebrewæœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Homebrew"
            echo "è¯·è®¿é—® https://brew.sh è·å–å®‰è£…æŒ‡å—"
            exit 1
        fi
        
        if brew install jq; then
            print_success "jqå®‰è£…æˆåŠŸï¼"
        else
            print_error "jqå®‰è£…å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¿è¡Œ: brew install jq"
            exit 1
        fi
    else
        print_success "jqå·¥å…·å·²å®‰è£…"
    fi
}

# 3. è·å–ç”¨æˆ·è¾“å…¥
get_user_input() {
    echo -e "\n\033[33mğŸ“ æ˜¯å¦è¦æ‰‹åŠ¨è¾“å…¥ starting_sub_id å€¼? (é»˜è®¤: ${DEFAULT_VALUE})\033[0m"
    echo -e "\033[33mæ‚¨æœ‰2ç§’æ—¶é—´é€‰æ‹©(y)ï¼Œè¶…æ—¶å°†ä½¿ç”¨é»˜è®¤å€¼\033[0m"
    read -t 2 -p "â¡ï¸ è¯·è¾“å…¥yæ‰‹åŠ¨è¾“å…¥ï¼Œæˆ–ç›´æ¥å›è½¦ä½¿ç”¨é»˜è®¤å€¼: " USER_CHOICE
    
    if [[ "$USER_CHOICE" == "y" || "$USER_CHOICE" == "Y" ]]; then
        read -p "è¯·è¾“å…¥æ–°çš„ starting_sub_id å€¼: " NEW_VALUE
        print_info "å°†ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥å€¼: ${NEW_VALUE}"
    else
        NEW_VALUE=$DEFAULT_VALUE
        print_info "å°†ä½¿ç”¨é»˜è®¤å€¼: ${NEW_VALUE}"
    fi
}


# ä¿®æ”¹ritual.shæ–‡ä»¶
modify_ritual_sh() {
    local ritual_sh_path="$1"
    local new_value="$2"
    
    print_info "æ­£åœ¨ä¿®æ”¹: $ritual_sh_path"
    
    if [[ ! -f "$ritual_sh_path" ]]; then
        print_error "æ‰¾ä¸åˆ°æ–‡ä»¶: $ritual_sh_path"
        exit 1
    fi
    
    # æ˜¾ç¤ºåŸå§‹æ–‡ä»¶å†…å®¹ï¼ˆè°ƒè¯•ç”¨ï¼‰
    print_info "åŸå§‹æ–‡ä»¶å†…å®¹:"
    grep -A 2 "starting_sub_id" "$ritual_sh_path" || echo "æœªæ‰¾åˆ°starting_sub_idç›¸å…³å†…å®¹"
    
    # å¤‡ä»½åŸæ–‡ä»¶
    cp "$ritual_sh_path" "${ritual_sh_path}.bak"
    
    # ä¿®æ”¹jqå‘½ä»¤ä¸­çš„å€¼
    if ! perl -i -pe "s/\.chain\.snapshot_sync\.starting_sub_id = \d+/\.chain\.snapshot_sync\.starting_sub_id = ${new_value}/g" "$ritual_sh_path"; then
        print_error "ä¿®æ”¹jqå‘½ä»¤å¤±è´¥"
        exit 1
    fi
    
    # ä¿®æ”¹echoè¯­å¥ä¸­çš„å€¼
    if ! perl -i -pe "s/echo \"- starting_sub_id: \d+\"/echo \"- starting_sub_id: ${new_value}\"/g" "$ritual_sh_path"; then
        print_error "ä¿®æ”¹echoè¯­å¥å¤±è´¥"
        exit 1
    fi
    
    # æ˜¾ç¤ºä¿®æ”¹åå†…å®¹ï¼ˆè°ƒè¯•ç”¨ï¼‰
    print_info "ä¿®æ”¹åæ–‡ä»¶å†…å®¹:"
    grep -A 2 "starting_sub_id" "$ritual_sh_path" || echo "æœªæ‰¾åˆ°starting_sub_idç›¸å…³å†…å®¹"
    
    # éªŒè¯ä¸¤å¤„ä¿®æ”¹
    if grep -q "\.chain\.snapshot_sync\.starting_sub_id = ${new_value}" "$ritual_sh_path" && \
       grep -q "echo \"- starting_sub_id: ${new_value}\"" "$ritual_sh_path"; then
        print_success "ä¿®æ”¹æˆåŠŸï¼å¤‡ä»½æ–‡ä»¶: ${ritual_sh_path}.bak"
    else
        print_error "éªŒè¯å¤±è´¥: æ–‡ä»¶å†…å®¹æœªæ­£ç¡®ä¿®æ”¹"
        print_info "è¯·æ£€æŸ¥æ–‡ä»¶ä¸­ starting_sub_id çš„ç›¸å…³è¯­å¥"
        exit 1
    fi
}

# 5. ä¿®æ”¹config.jsonæ–‡ä»¶
modify_config_json() {
    local config_path="$1"
    local new_value="$2"
    
    print_info "æ­£åœ¨ä¿®æ”¹: $config_path"
    
    if [[ ! -f "$config_path" ]]; then
        print_error "æ‰¾ä¸åˆ°é…ç½®æ–‡ä»¶: $config_path"
        print_info "å°è¯•åœ¨ä»¥ä¸‹ä½ç½®æŸ¥æ‰¾:"
        find "$WORK_DIR" -name "config.json" -print 2>/dev/null
        exit 1
    fi
    
    # å¤‡ä»½åŸæ–‡ä»¶
    cp "$config_path" "${config_path}.bak"
    
    # ä¿®æ”¹æ–‡ä»¶å†…å®¹
    if ! jq --arg new_val "$new_value" '.chain.snapshot_sync.starting_sub_id = ($new_val | tonumber)' "$config_path" > temp.json; then
        print_error "ä¿®æ”¹config.jsonå¤±è´¥"
        exit 1
    fi
    
    mv temp.json "$config_path"
    print_success "config.jsonä¿®æ”¹æˆåŠŸ"
    
    # éªŒè¯ä¿®æ”¹
    if jq -e ".chain.snapshot_sync.starting_sub_id == ${new_value}" "$config_path" >/dev/null; then
        print_success "éªŒè¯: ä¿®æ”¹å·²ç”Ÿæ•ˆ"
    else
        print_error "éªŒè¯å¤±è´¥: æ–‡ä»¶å†…å®¹æœªæ­£ç¡®ä¿®æ”¹"
        exit 1
    fi
}

# 6. æ‰§è¡Œritual.sh
run_ritual_sh() {
    local ritual_sh_path="$1"
    
    print_info "æ­£åœ¨æ‰§è¡Œritual.sh..."
    
    if [[ ! -f "$ritual_sh_path" ]]; then
        print_error "æ‰¾ä¸åˆ°æ–‡ä»¶: $ritual_sh_path"
        exit 1
    fi
    
    if ! chmod +x "$ritual_sh_path"; then
        print_error "æ— æ³•è®¾ç½®æ‰§è¡Œæƒé™"
        exit 1
    fi
    
    cd "$(dirname "$ritual_sh_path")" || {
        print_error "æ— æ³•åˆ‡æ¢åˆ°ritual.shæ‰€åœ¨ç›®å½•"
        exit 1
    }
    
    if ! ./ritual.sh; then
        print_error "æ‰§è¡Œritual.shå¤±è´¥"
        exit 1
    fi
    
    print_success "ritual.shæ‰§è¡Œå®Œæˆ"
}

# è·å–ritual.shè·¯å¾„
get_ritual_sh_path() {
    if [[ ! -f "$RITUAL_COMMAND_PATH" ]]; then
        print_error "æ‰¾ä¸åˆ°ritual.commandæ–‡ä»¶: $RITUAL_COMMAND_PATH"
        exit 1
    fi
    
    # ä»ritual.commandä¸­æå–ritual.shè·¯å¾„
    RL_SWARM_PATH=$(grep -o 'cd "[^"]*"' "$RITUAL_COMMAND_PATH" | sed 's/cd "//;s/"//')
    if [[ -z "$RL_SWARM_PATH" ]]; then
        print_error "æ— æ³•ä»ritual.commandä¸­æå–ritual.shè·¯å¾„"
        print_info "ritual.commandå†…å®¹:"
        cat "$RITUAL_COMMAND_PATH"
        exit 1
    fi
    
    RITUAL_SH_PATH="$RL_SWARM_PATH/ritual.sh"
    echo "$RITUAL_SH_PATH"
}

# è·å–config.jsonè·¯å¾„
get_config_path() {
    CONFIG_PATH="$WORK_DIR/config.json"
    
    if [[ ! -f "$CONFIG_PATH" ]]; then
        print_error "é»˜è®¤ä½ç½®æ‰¾ä¸åˆ°config.json: $CONFIG_PATH"
        print_info "å°è¯•è‡ªåŠ¨æŸ¥æ‰¾config.json..."
        
        FOUND_CONFIG=$(find "$HOME" -name "config.json" -print -quit 2>/dev/null)
        if [[ -n "$FOUND_CONFIG" ]]; then
            print_info "æ‰¾åˆ°config.jsonåœ¨: $FOUND_CONFIG"
            echo "$FOUND_CONFIG"
            return
        else
            print_error "æ— æ³•æ‰¾åˆ°config.jsonæ–‡ä»¶"
            exit 1
        fi
    fi
    
    echo "$CONFIG_PATH"
}

# ä¸»ç¨‹åº
main() {
    print_header "å¼€å§‹æ‰§è¡Œè‡ªåŠ¨åŒ–é…ç½®"
    
    # 1. æ£€æŸ¥Docker
    check_docker
    
    # 2. æ£€æŸ¥jqå·¥å…·
    check_jq
    
    # 3. è·å–ç”¨æˆ·è¾“å…¥
    get_user_input
    
    # è·å–ritual.shå®é™…è·¯å¾„
    RITUAL_SH_PATH=$(get_ritual_sh_path)
    print_info "æ‰¾åˆ°ritual.shè·¯å¾„: $RITUAL_SH_PATH"
    
    # 4. ä¿®æ”¹ritual.sh
    modify_ritual_sh "$RITUAL_SH_PATH" "$NEW_VALUE"
    
    # è·å–config.jsonè·¯å¾„
    CONFIG_PATH=$(get_config_path)
    print_info "æ‰¾åˆ°config.jsonè·¯å¾„: $CONFIG_PATH"
    
    # 5. ä¿®æ”¹config.json
    modify_config_json "$CONFIG_PATH" "$NEW_VALUE"
    
    # 6. æ‰§è¡Œritual.sh
    run_ritual_sh "$RITUAL_SH_PATH"
    
    print_header "æ‰€æœ‰æ“ä½œå·²å®Œæˆ ğŸ‰"
    echo -e "\033[32mâœ” è®¾ç½®çš„starting_sub_idå€¼: ${NEW_VALUE}\033[0m"
    echo -e "\033[32mâœ” ritual.shè·¯å¾„: ${RITUAL_SH_PATH}\033[0m"
    echo -e "\033[32mâœ” config.jsonè·¯å¾„: ${CONFIG_PATH}\033[0m"
    echo -e "\033[32mâœ” å®Œæˆæ—¶é—´: $(date)\033[0m"
    echo -e "\n\033[33mâš ï¸ æ³¨æ„ï¼šå¦‚æœé‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·æ£€æŸ¥å¤‡ä»½æ–‡ä»¶(.bak)\033[0m"
}

# æ‰§è¡Œä¸»ç¨‹åº
main
